<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[风依旧]]></title>
  <link href="http://windstill.me/atom.xml" rel="self"/>
  <link href="http://windstill.me/"/>
  <updated>2014-10-24T16:48:46+08:00</updated>
  <id>http://windstill.me/</id>
  <author>
    <name><![CDATA[WindStill]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[在Rails中使用hstore和Array类型]]></title>
    <link href="http://windstill.me/blog/2014/10/21/using-hash-and-array-of-hstore-with-rails/"/>
    <updated>2014-10-21T12:05:15+08:00</updated>
    <id>http://windstill.me/blog/2014/10/21/using-hash-and-array-of-hstore-with-rails</id>
    <content type="html"><![CDATA[<p>最近项目技术选型从 MySQL+MongoDB 转到 PostgreSQL，但是 MongoDB 支持存储 Array 和 JSON 数据类型在某些场景下还是很方便的。比如手机通讯录里的联系人，一个联系人有多个号码、多个地址，如果使用传统的数据类型，可能要三个表来存储这些信息；另一个问题在于，一般编辑联系人的时候，会同时增删改N个号码 + N条地址，这是再去操作三个表逻辑上也会复杂不少。但是如果把多个号码和多个地址以 JSON 的 array 及 key-value 形式存储在同一个字段中，这样曾删改的时候会方便很多。索性PostgreSQL，也有相应的字段类型来支持此场景，比如 hstore。</p>

<!-- more -->


<p>Rails 4.1 中的一个新特性就是对 PostgreSQL 的hstore类型的支持。而 Rails 之前的版本需要安装 <a href="https://github.com/diogob/activerecord-postgres-hstore"><code>activerecord-postgres-hstore</code></a> gem。下面说说 Rails 中使用 hstore 的方法。</p>

<h3>增加 hstore extenstion</h3>

<p>首先创建一个migration，启用 hstore extension。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddHstoreExtension</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
</span><span class='line'>    <span class="n">execute</span> <span class="s2">&quot;CREATE EXTENSION IF NOT EXISTS hstore&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
</span><span class='line'>    <span class="n">execute</span> <span class="s2">&quot;DROP EXTENSION IF EXISTS hstore&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>还有一种更简便的写法，不需要用 execute 执行原生的 SQL 语句。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddHstoreExtension</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
</span><span class='line'>    <span class="n">enable_extension</span> <span class="ss">:hstore</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
</span><span class='line'>    <span class="n">disable_extension</span> <span class="ss">:hstore</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用 hstore 创建 model</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateContacts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:contacts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:gender</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">hstore</span> <span class="ss">:telphones</span><span class="p">,</span> <span class="ss">:array</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">hstore</span> <span class="ss">:settings</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>:array =&gt; true</code> 表示当前字段是数组类型。字段 <code>telphones</code> 是 <code>hstore</code> 类型的数组，字段 <code>settings</code> 是 <code>hstore</code> 类型。</p>

<h3>使用示例</h3>

<h4>创建 model</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">contact</span> <span class="o">=</span> <span class="no">Contact</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;windstill&#39;</span><span class="p">,</span> <span class="ss">gender</span><span class="p">:</span> <span class="s1">&#39;先生&#39;</span><span class="p">,</span> <span class="ss">telphones</span><span class="p">:</span>
</span><span class='line'><span class="o">[</span><span class="p">{</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;手机&#39;</span><span class="p">,</span> <span class="ss">num</span><span class="p">:</span> <span class="s1">&#39;15155556666&#39;</span><span class="p">},</span> <span class="p">{</span><span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;工作&#39;</span><span class="p">,</span> <span class="ss">num</span><span class="p">:</span> <span class="s1">&#39;010-86118233&#39;</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="ss">settings</span><span class="p">:</span> <span class="p">{</span><span class="ss">theme</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="ss">language</span><span class="p">:</span> <span class="s1">&#39;cn&#39;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>获取字段</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">settings</span>                    <span class="c1"># =&gt; {theme: &#39;white&#39;, language: &#39;cn&#39;}</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">settings</span><span class="o">[</span><span class="s2">&quot;theme&quot;</span><span class="o">]</span>            <span class="c1"># =&gt; &quot;white&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">telphones</span>                    <span class="c1"># =&gt; [{type: &#39;手机&#39;, num: &#39;15155556666&#39;}, {type: &#39;工作&#39;, num: &#39;010-86118233&#39;}]</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">telphones</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>               <span class="c1"># =&gt; {type: &#39;手机&#39;, num: &#39;15155556666&#39;}</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">telphones</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s2">&quot;num&quot;</span><span class="o">]</span>       <span class="c1"># =&gt; &quot;15155556666&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>更新字段</h4>

<p>如果是直接对 contact 的字段（比如name、settings、telphones）进行赋值，那么可以直接 save。
但是如果对 settings 和 telphones 里面的 hash 值进行修改，需要用 <code>attr_will_change</code> 通知 rails，因为 hash 的key-value不是 Active Record model 对象。如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="ss">theme</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="ss">language</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">}</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">telphones</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;手机&quot;</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">telphones</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="s2">&quot;num&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;137700001111&quot;</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">telphones_will_change!</span>
</span><span class='line'><span class="n">contact</span><span class="o">.</span><span class="n">save</span>
</span></code></pre></td></tr></table></div></figure>


<h4>查询</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Contact</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;settings -&gt; &#39;language&#39; = &#39;en&#39;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">Contact</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;&#39;15155556666&#39; = ANY (SELECT unnest(telphones) -&gt; &#39;num&#39;)&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>也可以写个 scope：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scope</span> <span class="ss">:where_any</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;? = ANY (SELECT unnest(</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">) -&gt; ?)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">scope</span> <span class="ss">:where_all</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;? = ALL (SELECT unnest(</span><span class="si">#{</span><span class="n">column</span><span class="si">}</span><span class="s2">) -&gt; ?)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>建立索引</h3>

<p>在 PostgreSQL 中可以对普通的 array 建立索引，可以对 hstore 建立索引。但是要对 hstore 类型的 array 建立索引就会有问题，会提示你要对 hstore[] 定义 operator class。</p>

<p>下面是对 hstore 建立索引的示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">add_index</span> <span class="ss">:contacts</span><span class="p">,</span> <span class="ss">:telphones</span><span class="p">,</span> <span class="ss">:using</span> <span class="o">=&gt;</span> <span class="ss">:gin</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有两种索引可以选择：gist 和 gin。他们的性能区别如下：</p>

<ul>
<li>GIN index lookups are about three times faster than GiST</li>
<li>GIN indexes take about three times longer to build than GiST</li>
<li>GIN indexes are about ten times slower to update than GiST</li>
<li>GIN indexes are two-to-three times larger than GiST</li>
</ul>


<h3>参考文章</h3>

<ul>
<li><a href="http://inopinatus.org/2013/07/12/using-arrays-of-hstore-with-rails-4/">Using arrays of hstore with Rails 4</a></li>
<li><a href="http://jes.al/2013/11/using-postgres-hstore-rails4/">Using Postgres Hstore with Rails 4</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Rails和Postgis开发基于地理位置应用的安装与配置]]></title>
    <link href="http://windstill.me/blog/2014/10/15/rails-with-postgis/"/>
    <updated>2014-10-15T15:24:58+08:00</updated>
    <id>http://windstill.me/blog/2014/10/15/rails-with-postgis</id>
    <content type="html"><![CDATA[<p><a href="http://postgis.refractions.net/"><code>PostGIS</code></a> 是关系型数据库 <a href="http://www.postgresql.org/"><code>PostgreSQL</code></a> 一个扩展，它为PostgreSQL提供了存储空间地理数据的支持，使PostgreSQL成为了一个空间数据库，能够进行空间数据管理、数量测量与几何拓扑分析。现在已经有好多为 Rails 提供地理空间数据操作的 gem。所以处理地理空间数据还是比较简单的，但是开发环境配置还有不少工作要做。</p>

<!-- more -->


<h3>环境依赖</h3>

<p>本文以 Mac OS X系统为例，需要安装以下内容：</p>

<ul>
<li> XCode</li>
<li> Homebrew</li>
<li> Postgresql</li>
<li> Postgis</li>
<li> Ruby</li>
<li> Rails</li>
</ul>


<p>下面单说 Postgresql 及 Postgis 安装</p>

<h4>安装 Postgresql 和 Postgis</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install postgresql
</span><span class='line'>brew install postgis</span></code></pre></td></tr></table></div></figure>


<h4>检查系统是否正确安装 postgis</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~$ psql -U username
</span><span class='line'>=# select pg_available_extensions where name like ‘postgis%’;</span></code></pre></td></tr></table></div></figure>


<p>Mac 用户还可以直接下载 <a href="http://postgresapp.com/"><code>Postgres.app</code></a>，拖入applications文件夹。Postgres.app 包含 PostgreSQL 常用的扩展和工具：</p>

<ul>
<li>PostgreSQL 9.3.5</li>
<li>PostGIS 2.1.3</li>
<li>Procedural languages: PL/pgSQL, PL/Perl, PL/Python, and PLV8 (Javascript)</li>
<li>Popular extensions, including hstore and uuid-ossp, and more</li>
<li>A number of command-line utilities for managing PostgreSQL and working with GIS data</li>
</ul>


<h3>Rails 相关配置</h3>

<h4>新建 Rails 应用</h4>

<p>先使用 postgresql 适配器新建应用（database参数可选，默认sqlite）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new my_app --database=postgresql</span></code></pre></td></tr></table></div></figure>


<h4>配置 Gemfile</h4>

<p>打开gemfile文件，添加如下 gem ：</p>

<ul>
<li> pg</li>
<li> rgeo</li>
<li> activerecord-postgis-adapter</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'pg'
</span><span class='line'>gem 'rgeo'
</span><span class='line'>gem 'activerecord-postgis-adapter'</span></code></pre></td></tr></table></div></figure>


<h4>配置 database.yml</h4>

<p>打开 database.yml 文件，adapter 使用 postgis ：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>development:
</span><span class='line'>  username:           your_username
</span><span class='line'>  adapter:            postgis
</span><span class='line'>  host:               localhost
</span><span class='line'>  postgis_extension: postgis
</span><span class='line'>  schema_search_path: public</span></code></pre></td></tr></table></div></figure>


<p>postgis_extension 表明应用在创建数据库的时候安装 postgis extension。当执行 <code>rake db:create</code> 命令的时候，postgresql会有类似如下的操作：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE SCHEMA postgis;
</span><span class='line'>CREATE EXTENSION postgis WITH SCHEMA postgis;</span></code></pre></td></tr></table></div></figure>


<p>如果 postgis extension 不是安装在 public schema (默认安装在 public schema)，还得把 postgis 的 schema 添加到 <code>schema_search_path</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>development:
</span><span class='line'>  schema_search_path: public, postgis</span></code></pre></td></tr></table></div></figure>


<p>其他支持的选项：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>development:
</span><span class='line'>  adapter: postgis
</span><span class='line'>  encoding: unicode
</span><span class='line'>  postgis_extension: postgis      # default is postgis
</span><span class='line'>  schema_search_path: public,postgis
</span><span class='line'>  pool: 5
</span><span class='line'>  database: my_app_development    # your database name
</span><span class='line'>  username: my_app_user           # the username your app will use to connect
</span><span class='line'>  password: my_app_password       # the user's password
</span><span class='line'>  su_username: my_global_user     # a superuser for the database
</span><span class='line'>  su_password: my_global_pasword  # the superuser's password</span></code></pre></td></tr></table></div></figure>


<h4>创建 model 和 table</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g model earthquake location:point</span></code></pre></td></tr></table></div></figure>


<p>要存储空间数据，必须得创建空间类型的字段。Postgis 提供了很多空间类型，包括：point, linestring, polygon以及不同类型的集合。activerecord-postgis-adapter 继承了 ActiveRecord 的 migration 句法，可以支持空间类型。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CreateEarthquakes &lt; ActiveRecord::Migration  
</span><span class='line'>  def change    
</span><span class='line'>      create_table :earthquakes do |t|   
</span><span class='line'>          t.column :shape1, :geometry
</span><span class='line'>          t.geometry :shape2
</span><span class='line'>          t.line_string :path, :srid =&gt; 3785   
</span><span class='line'>          t.point :location, :geographic =&gt; true
</span><span class='line'>          t.point :lonlatheight, :geographic =&gt; true, :has_z =&gt; true    
</span><span class='line'>          t.timestamps    
</span><span class='line'>      end  
</span><span class='line'>      
</span><span class='line'>      add_index :earthquakes, :location, :spatial =&gt; true
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>第一个字段“shape1”，使用的是“geometry”类型，这是空间数据的基础类型（base class），表明可以容纳任何空间类型的数据。</p>

<p>第二个字段“shape2”，使用的是第一个字段定义的简写句法。</p>

<p>第三个字段“path”，使用了一个明确的几何类型 <code>line_string</code>，并且定义了srid（spatial reference ID）。表明这个字段只接受 <code>line_string</code> 类型的数据，而且SRID等于3785。</p>

<p>第四个字段“location”，是 <code>point</code>类型，同时定义了“geographic”，表明这个字段接受 经度/纬度 数据，并且以球型做相关计算（比如两点之间的距离）。</p>

<p>第五个字段“lonlatheight”，包含了“z”坐标，一般用来记录高度。</p>

<p>以下是activerecord-postgis-adapter所支持的postgis类型：</p>

<ul>
<li>:geometry &ndash; Any geometric type</li>
<li>:point &ndash; Point data</li>
<li>:line_string &ndash; LineString data</li>
<li>:polygon &ndash; Polygon data</li>
<li>:geometry_collection &ndash; Any collection type</li>
<li>:multi_point &ndash; A collection of Points</li>
<li>:multi_line_string &ndash; A collection of LineStrings</li>
<li>:multi_polygon &ndash; A collection of Polygons</li>
</ul>


<p>最后，还支持创建空间索引：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def change
</span><span class='line'>  add_index :earthquakes, :location, :spatial =&gt; true
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h4>配置 Model</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Earthquake &lt; ActiveRecord::Base
</span><span class='line'>
</span><span class='line'>  # 默认使用 Geos 空间字段实现
</span><span class='line'>  self.rgeo_factory_generator = RGeo::Geos.factory_generator
</span><span class='line'>
</span><span class='line'>  # 也可以设置某个字段为 geographic 空间字段实现
</span><span class='line'>  set_rgeo_factory_for_column(:location, RGeo::Geographic.spherical_factory(:srid =&gt; 4326))
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>空间数据操作</h3>

<p>一旦安装了以上gem，并且配置了数据库以及执行了migration，就可以以RGeo对象与model中的空间数据交互了。</p>

<p><a href="https://github.com/rgeo/rgeo"><code>RGeo</code></a> 是Opengis Simple Features 标准的 Ruby 实现。它是一个空间数据类型结合，包括points, lines, polygons, 和 collections。还提供标准的空间数据分析操作，比如计算交集或包含关系，计算长度或区域等等。</p>

<h4>空间数据读写</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>record = Earthquake.find(1)
</span><span class='line'>p = record.location                # Returns an RGeo::Feature::Point
</span><span class='line'>puts p.x                           # displays the x coordinate
</span><span class='line'>puts p.geometry_type.type_name     # displays "Point"
</span><span class='line'>
</span><span class='line'>record.location = 'POINT(-122 47)'    # sets the value with WKT string
</span><span class='line'>record.save
</span><span class='line'>
</span><span class='line'>factory = p.factory                # returns a spherical factory
</span><span class='line'># factory = Earthquake.rgeo_factory_for_column(:location)
</span><span class='line'>p2 = factory.point(-122, 47)       # p2 is a point in a spherical factory
</span><span class='line'>record.lonlat = p2                 # sets the value to the given point
</span><span class='line'>record.shape1 = p2                 # shape1 uses a flat geos factory, so it
</span><span class='line'>                                   # will cast p2 into that coordinate system
</span><span class='line'>                                   # before setting the value
</span><span class='line'>record.save</span></code></pre></td></tr></table></div></figure>


<h4>空间数据查询</h4>

<p>location距离坐标(116.458104 39.966293) 10公里以内的Earthquake：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Earthquake.where("st_dwithin(location, 'point(116.458104 39.966293)', 10000)").count</span></code></pre></td></tr></table></div></figure>


<p>location距离坐标(116.458104 39.966293) 10公里以内的Earthquake，并按距离排序：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Order.select("orders.*, st_distance(location, 'point(116.458104 39.966293)') as distance").where("st_dwithin(location, 'point(116.458104 39.966293)', 10000)").order("distance”)</span></code></pre></td></tr></table></div></figure>


<p>location在矩形区域POLYGON((116.424031 39.955045, 116.468731 39.955045, 116.468731 39.983357, 116.424031 39.983357, 116.424031 39.955045))内的Earthquake：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Order.where("ST_Intersects('SRID=4326;POLYGON((116.424031 39.955045, 116.468731 39.955045, 116.468731 39.983357, 116.424031 39.983357, 116.424031 39.955045))',location)")</span></code></pre></td></tr></table></div></figure>


<p><small>说明：矩形是由4个点组成，但是使用POLYGON需要5个点，其中第一个和最后一个是同一个点，个人理解是为了形成一个闭合。另外使用此方法可以构建任意的多边形。</small></p>

<h3>参考文章</h3>

<ul>
<li><a href="https://github.com/rgeo/activerecord-postgis-adapter">ActiveRecord connection adapter for PostGIS, based on postgresql and rgeo</a></li>
<li><a href="http://www.waratuman.com/2012/10/26/postgis_and_rails/">POSTGIS AND RAILS</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[解决ImageMagick和RMagick在OS X下使用出现的问题]]></title>
    <link href="http://windstill.me/blog/2014/07/16/imagemagick-rmagick-osx/"/>
    <updated>2014-07-16T10:50:42+08:00</updated>
    <id>http://windstill.me/blog/2014/07/16/imagemagick-rmagick-osx</id>
    <content type="html"><![CDATA[<p>每次安装 <code>RMagick</code> 这个gem都会遇到问题，并且每次的问题还都不一样，有的时候是 <code>ImageMagick</code> 的问题，有时候是 <code>RMagick</code> 不能安装，这次是安装了以后，启动Rails的时候，报错说是 <code>libMagickCore-6.Q16.2.dylib</code> 版本不对。错误详情如下：</p>

<!-- more -->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/activesupport-3.2.12/lib/active_support/dependencies.rb:251:in `require': dlopen(/Users/windstill/.rvm/gems/ruby-1.9.3-p194/extensions/x86_64-darwin-13/1.9.1/rmagick-2.13.2/RMagick2.bundle, 9): Library not loaded: /usr/local/lib/libltdl.7.dylib (LoadError)
</span><span class='line'>  Referenced from: /usr/local/lib/libMagickCore-6.Q16.2.dylib
</span><span class='line'>  Reason: Incompatible library version: libMagickCore-6.Q16.2.dylib requires version 11.0.0 or later, but libltdl.7.dylib provides version 10.0.0 - /Users/windstill/.rvm/gems/ruby-1.9.3-p194/extensions/x86_64-darwin-13/1.9.1/rmagick-2.13.2/RMagick2.bundle
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/activesupport-3.2.12/lib/active_support/dependencies.rb:251:in `block in require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/activesupport-3.2.12/lib/active_support/dependencies.rb:236:in `load_dependency'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/activesupport-3.2.12/lib/active_support/dependencies.rb:251:in `require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/rmagick-2.13.2/lib/rmagick.rb:11:in `&lt;top (required)&gt;'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler/runtime.rb:76:in `require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler/runtime.rb:76:in `block (2 levels) in require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler/runtime.rb:72:in `each'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler/runtime.rb:72:in `block in require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler/runtime.rb:61:in `each'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler/runtime.rb:61:in `require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194@global/gems/bundler-1.6.3/lib/bundler.rb:132:in `require'
</span><span class='line'>  from /Users/windstill/dev/rails/movie/config/application.rb:13:in `&lt;top (required)&gt;'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/railties-3.2.12/lib/rails/commands.rb:39:in `require'
</span><span class='line'>  from /Users/windstill/.rvm/gems/ruby-1.9.3-p194/gems/railties-3.2.12/lib/rails/commands.rb:39:in `&lt;top (required)&gt;'
</span><span class='line'>  from script/rails:6:in `require'
</span><span class='line'>  from script/rails:6:in `&lt;main&gt;'</span></code></pre></td></tr></table></div></figure>


<p>使用 <code>brew unlink libtool &amp;&amp; brew link libtool</code> 命令解决问题。可能会出现如下问题：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Linking /usr/local/Cellar/libtool/2.4.2...
</span><span class='line'>Error: Could not symlink include/ltdl.h
</span><span class='line'>Target /usr/local/include/ltdl.h
</span><span class='line'>already exists. You may want to remove it:
</span><span class='line'>  rm /usr/local/include/ltdl.h
</span><span class='line'>
</span><span class='line'>To force the link and overwrite all conflicting files:
</span><span class='line'>  brew link --overwrite libtool
</span><span class='line'>
</span><span class='line'>To list all files that would be deleted:
</span><span class='line'>  brew link --overwrite --dry-run libtool</span></code></pre></td></tr></table></div></figure>


<p>按照提示输入 <code>brew link --overwrite libtool</code>。</p>

<h3>参考文章</h3>

<ul>
<li><a href="http://stackoverflow.com/questions/7412208/imagemagick-and-os-x-lion-trouble">ImageMagick and OS X Lion trouble</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA['Mysql2::Error: Got Error 28 From Storage Engine'问题解决]]></title>
    <link href="http://windstill.me/blog/2014/07/02/mysql2-error-28-storage-enginewen/"/>
    <updated>2014-07-02T10:35:17+08:00</updated>
    <id>http://windstill.me/blog/2014/07/02/mysql2-error-28-storage-enginewen</id>
    <content type="html"><![CDATA[<h3>问题原因</h3>

<p>今天发现MySQL数据库中没有写入新数据，于是看了下Rails后端的日志，发现报了一个<code>Error: Mysql2::Error: Got error 28 from storage engine: SHOW FULL FIELDS FROM plays</code>错误。网上搜了一通说是空间不足造成的。</p>

<!--more-->


<p>使用 <code>df -h</code> 命令，结果如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@windstill:/# df -h
</span><span class='line'>Filesystem            Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/mapper/windstill-root
</span><span class='line'>                       28G   28G    0G   0% /
</span><span class='line'>none                   16G  220K   16G   1% /dev
</span><span class='line'>none                   16G     0   16G   0% /dev/shm
</span><span class='line'>none                   16G   52K   16G   1% /var/run
</span><span class='line'>none                   16G     0   16G   0% /var/lock
</span><span class='line'>/dev/mapper/windstill-data_backup
</span><span class='line'>                       28G   16G   11G  59% /data_backup
</span><span class='line'>/dev/mapper/windstill-mysql
</span><span class='line'>                       65G   15G   47G  24% /mysql
</span><span class='line'>/dev/mapper/windstill-opt
</span><span class='line'>                       28G   15G   12G  55% /opt
</span><span class='line'>/dev/mapper/windstill-redis
</span><span class='line'>                       28G   17G  9.8G  63% /redis
</span><span class='line'>/dev/mapper/windstill-prod
</span><span class='line'>                       28G   13G   14G  50% /prod
</span><span class='line'>/dev/mapper/windstill-mongodb
</span><span class='line'>                       65G   50G   12G  82% /mongodb
</span><span class='line'>                       </span></code></pre></td></tr></table></div></figure>


<p></p>

<p>可以看出 <code>/mysql</code> 空间还是很足的，还有47G空间可用，那是什么原因呢。随着深入了解，原来MySQL查询的时候会生成一些临时的表，在默认的配置里，这些表会被创建在 <code>/</code> 挂载点（目录）中。再结合上述结果中，我的 <code>/</code> 已经没有可用空间了，那这就是问题所在了。</p>

<h3>解决方法</h3>

<p>既然知道问题的原因是 <code>/</code> 空间不足，那么解决方法就是清理 <code>/</code> 无用的文件。
使用 <code>ls -alh</code> 命令，结果如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-rw-r--r--  1 nobody   root     15G 2014-07-02 11:04 nginx.access.log
</span><span class='line'>-rw-r--r--  1 nobody   root      2G 2014-07-02 11:04 nginx_assets.error.log</span></code></pre></td></tr></table></div></figure>


<p>发现nginx的log文件都太大，于是使用 <code>rm</code> 命令把他们一一删除了。但是另外的一个小问题出现了，我再次使用 <code>df -h</code> 命令发现 <code>/</code> 可用空间仍然是0。</p>

<p>后来了解到，在Linux或者Unix系统中，通过rm或者文件管理器删除文件将会从文件系统的目录结构上解除链接(unlink)。然而如果文件是被打开的（有一个进程正在使用），那么进程将仍然可以读取该文件，磁盘空间也一直被占用。而我删除的是Nginx的log文件，删除的时候文件应该正在被使用。</p>

<p>通过 <code>lsof |grep deleted</code> 命令可以获得一个已经被删除但是仍然被应用程序占用的文件列表，如下所示：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@windstill:/# lsof |grep deleted
</span><span class='line'>nginx      6316   nobody    3w      REG              251,4 15966896128    1471723 /tmp/nginx.access.log (deleted)
</span><span class='line'>nginx      6316   nobody    4w      REG              251,4  2815307776    1471730 /tmp/nginx.error.log (deleted)</span></code></pre></td></tr></table></div></figure>


<p>从输出结果可以看到log文件还在被使用，未被释放空间。一种方法是kill掉Nginx进程，让os自动回收磁盘空间。但这种方法显然不好，会影响线上应用。索性Nginx有个重新打开日志文件的方法：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nginx -s reopen</span></code></pre></td></tr></table></div></figure>


<p>至此，所有问题都解决了。</p>

<h3>参考文章</h3>

<ul>
<li><a href="http://serverfault.com/questions/399068/got-error-28-from-storage-engine-disk-full-but-my-disk-are-not-full">Got error 28 from storage engine (disk full) but my disk are not full</a></li>
<li><a href="http://blog.csdn.net/wyzxg/article/details/4971843">linux删除文件后没有释放空间</a></li>
<li><a href="http://blog.csdn.net/dbanote/article/details/17169759">Nginx在Linux下的启动、停止和重加载</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mac Mavericks系统因为‘来自身份不明开发者’不能打开软件的解决方法]]></title>
    <link href="http://windstill.me/blog/2014/01/03/mavericks-unidentified-developer-app/"/>
    <updated>2014-01-03T17:29:52+08:00</updated>
    <id>http://windstill.me/blog/2014/01/03/mavericks-unidentified-developer-app</id>
    <content type="html"><![CDATA[<p>自从 <code>10.7 Lion</code> 升级到新系统<code>10.9 Mavericks</code> 后，一些小问题也就跟着来了。听说苹果是从 <code>10.8 Mountain Lion</code> （这个版本系统我没装过）系统开始启用了新的安全机制，默认只信任 App Store 下载的软件和拥有开发者 ID 签名的应用程序。也就是说新系统默认只能安装正规渠道（App Store 或被认可的开发人员）的软件，否则安装的时候就会弹出下图所示警告框：<code>打不开“xxx”，因为它来自身份不明的开发者</code>，如下图所示：</p>

<!-- more -->


<p><img class="center" src="http://blog-picture.qiniudn.com/94C990E2-7FC8-4117-B9EC-F17C338A2F96.png"></p>

<p>这个问题解决方法就是到 <code>系统偏好设置</code> 里设置一下就行了，步骤如下：</p>

<ul>
<li>点击 Mac 屏幕左上角的苹果标志，在下拉菜单里选择 <code>系统偏好设置…</code>，或者到 <code>应用程序</code> 里找到 <code>系统偏好设置</code> 应用。在弹出的设置面板里，点击第一行的小房子图标 <code>安全性与隐私</code> 。</li>
</ul>


<p><img class="center" src="http://blog-picture.qiniudn.com/02FAD525-62C0-450B-8C99-CBC9DD6ED1F5.png"></p>

<ul>
<li>在 <code>安全性与隐私</code> 设置面板里选择 <code>通用</code> 标签。可以看到上面截图里中间红框标出的几个选项了，把“允许从一下位置下载的应用程序”从默认的 <code>Mac App Store 和被认可的开发者</code> 改选为 <code>任何来源</code> 就行了。但按钮是灰的不能选，需要点击左下角红框内的锁按钮解锁。</li>
</ul>


<p><img class="center" src="http://blog-picture.qiniudn.com/4302E326-1889-4017-93F2-4C5ED6932168.png"></p>

<ul>
<li>系统会要求你输一下密码确认，解锁后就可以选择 <code>任何来源</code> 了，然后会如下图所示：</li>
</ul>


<p><img class="center" src="http://blog-picture.qiniudn.com/4E81CF94-FAC6-43C5-9707-9CD3F9EA17EA.png"></p>

<ul>
<li>点击 <code>允许来自任何来源</code> 按钮就 OK 了，这样被警告的应用程序就能正常安装、打开了。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linux设置系统时间和硬件时间]]></title>
    <link href="http://windstill.me/blog/2014/01/02/linux-set-time/"/>
    <updated>2014-01-02T11:46:08+08:00</updated>
    <id>http://windstill.me/blog/2014/01/02/linux-set-time</id>
    <content type="html"><![CDATA[<p>今天发现我们测试环境的服务器时间不对，居然超前了。然后谷歌了下linux系统相的关时间查看与设置。Linux时钟分为 <code>系统时钟</code>（System Clock）和 <code>硬件时钟</code>（Real Time Clock，简称RTC）。<code>系统时钟是</code>指当前Linux Kernel中的时钟，而<code>硬件时钟</code>则是主板上由电池供电的时钟，这个硬件时钟可以在BIOS中进行设置。当Linux启动时，硬件时钟会去读取系统时钟的设置，然后系统时钟就会独立于硬件运作。</p>

<!-- more -->


<p>Linux中的所有命令都是采用的系统时钟设置。在Linux中，用于时钟查看和设置的命令主要有<code>date</code>、<code>hwclock</code>和<code>clock</code>。其中，<code>clock</code>和<code>hwclock</code>用法相近，只用一个就行，只不过clock命令除了支持x86硬件体系外，还支持Alpha硬件体系。看了下我们的测试环境止只有hwclock可用，clock没有安装。</p>

<h3>1. date</h3>

<ul>
<li>查看系统时间</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># date</span></code></pre></td></tr></table></div></figure>


<ul>
<li>设置系统时间</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># date --set "01/02/14 10:19:20" (月/日/年 时:分:秒)</span></code></pre></td></tr></table></div></figure>


<h3>2. hwclock/clock</h3>

<ul>
<li>查看硬件时间</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># hwclock --show
</span><span class='line'>或者
</span><span class='line'># clock --show</span></code></pre></td></tr></table></div></figure>


<ul>
<li>设置硬件时间</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># hwclock --set --date="01/02/14 10:19:20"  (月/日/年 时:分:秒)
</span><span class='line'>或者
</span><span class='line'># clock --set --date="01/02/14 10:19:20"  (月/日/年 时:分:秒)</span></code></pre></td></tr></table></div></figure>


<h3>3. 硬件时间和系统时间的同步</h3>

<p>硬件时钟同步到系统时钟：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># hwclock --hctosys（hc代表硬件时间，sys代表系统时间）
</span><span class='line'>或者
</span><span class='line'># clock --hctosys</span></code></pre></td></tr></table></div></figure>


<p>系统时钟同步到硬件时钟：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># hwclock --systohc
</span><span class='line'>或者
</span><span class='line'># clock --systohc</span></code></pre></td></tr></table></div></figure>


<h3>4. 时区的设置</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@testserver-01:~# tzselect
</span><span class='line'>Please identify a location so that time zone rules can be set correctly.
</span><span class='line'>Please select a continent or ocean.
</span><span class='line'> 1) Africa
</span><span class='line'> 2) Americas
</span><span class='line'> 3) Antarctica
</span><span class='line'> 4) Arctic Ocean
</span><span class='line'> 5) Asia
</span><span class='line'> 6) Atlantic Ocean
</span><span class='line'> 7) Australia
</span><span class='line'> 8) Europe
</span><span class='line'> 9) Indian Ocean
</span><span class='line'>10) Pacific Ocean
</span><span class='line'>11) none - I want to specify the time zone using the Posix TZ format.
</span><span class='line'>#? 5 (输入5，亚洲)
</span><span class='line'>
</span><span class='line'>Please select a country.
</span><span class='line'> 1) Afghanistan         18) Israel            35) Palestine
</span><span class='line'> 2) Armenia         19) Japan         36) Philippines
</span><span class='line'> 3) Azerbaijan          20) Jordan            37) Qatar
</span><span class='line'> 4) Bahrain         21) Kazakhstan        38) Russia
</span><span class='line'> 5) Bangladesh          22) Korea (North)     39) Saudi Arabia
</span><span class='line'> 6) Bhutan          23) Korea (South)     40) Singapore
</span><span class='line'> 7) Brunei          24) Kuwait            41) Sri Lanka
</span><span class='line'> 8) Cambodia        25) Kyrgyzstan        42) Syria
</span><span class='line'> 9) China       26) Laos          43) Taiwan
</span><span class='line'>10) Cyprus          27) Lebanon           44) Tajikistan
</span><span class='line'>11) East Timor          28) Macau         45) Thailand
</span><span class='line'>12) Georgia         29) Malaysia          46) Turkmenistan
</span><span class='line'>13) Hong Kong       30) Mongolia          47) United Arab Emirates
</span><span class='line'>14) India       31) Myanmar (Burma)       48) Uzbekistan
</span><span class='line'>15) Indonesia       32) Nepal         49) Vietnam
</span><span class='line'>16) Iran        33) Oman          50) Yemen
</span><span class='line'>17) Iraq        34) Pakistan
</span><span class='line'>#? 9 (输入9，中国)
</span><span class='line'>
</span><span class='line'>Please select one of the following time zone regions.
</span><span class='line'>1) east China - Beijing, Guangdong, Shanghai, etc.
</span><span class='line'>2) Heilongjiang (except Mohe), Jilin
</span><span class='line'>3) central China - Sichuan, Yunnan, Guangxi, Shaanxi, Guizhou, etc.
</span><span class='line'>4) most of Tibet & Xinjiang
</span><span class='line'>5) west Tibet & Xinjiang
</span><span class='line'>#? 1 (输入1，北京时间)
</span><span class='line'>
</span><span class='line'>The following information has been given:
</span><span class='line'>
</span><span class='line'>  China
</span><span class='line'>  east China - Beijing, Guangdong, Shanghai, etc.
</span><span class='line'>
</span><span class='line'>Therefore TZ='Asia/Shanghai' will be used.
</span><span class='line'>Local time is now:    Thu Jan  2 11:55:36 CST 2014.
</span><span class='line'>Universal Time is now:    Thu Jan  2 03:55:36 UTC 2014.
</span><span class='line'>Is the above information OK?
</span><span class='line'>1) Yes
</span><span class='line'>2) No
</span><span class='line'>#? Yes
</span><span class='line'>Please enter 1 for Yes, or 2 for No.
</span><span class='line'>#? 1 (输入1，确认)</span></code></pre></td></tr></table></div></figure>


<h3>参考文章</h3>

<p><a href="http://os.51cto.com/art/200703/43943.htm">Linux操作系统下的时间设置方法介绍</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mac OSX 10.9 Mavericks系统安装MacVim]]></title>
    <link href="http://windstill.me/blog/2013/12/29/macvim-osx-mavericks/"/>
    <updated>2013-12-29T18:26:08+08:00</updated>
    <id>http://windstill.me/blog/2013/12/29/macvim-osx-mavericks</id>
    <content type="html"><![CDATA[<p>今天下午把Mac系统从Lion直接升级到了Mavericks，增加了不少新的功能和体验，具体参考官方说明 <a href="https://help.apple.com/osx-mavericks/whats-new-from-lion">OS X Mavericks的全新功能</a>。这次升级基本保持了原有的数据和配置，但是个别应用会因为系统升级瘦到影响，比如这次所说的<code>MacVim</code>应用。</p>

<!-- more -->


<h3>问题及解决</h3>

<p>升级完系统后，终端输入<code>mvim .</code>会出现以下错误信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dyld: Library not loaded: /System/Library/Perl/lib/5.10/libperl.dylib
</span><span class='line'>Referenced from: /Applications/MacVim.app/Contents/MacOS/Vim
</span><span class='line'>Reason: image not found
</span><span class='line'>Trace/BPT trap: 5</span></code></pre></td></tr></table></div></figure>


<p>原因是Mac X Mavericks 只有5.12 、5.16 已经没有了5.10。解决办法就是下载最新的Mavericks版本的MacVim <a href="https://github.com/b4winckler/macvim/releases/download/snapshot-72/MacVim-snapshot-72-Mavericks.tbz">MacVim-snapshot-72-Mavericks.tbz</a>。</p>

<p>其他OSX系统版本可以到 <a href="https://github.com/b4winckler/macvim/releases">https://github.com/b4winckler/macvim/releases</a> 下载。</p>

<p>下载解压后有三个文件<code>MacVim</code>、<code>mvim</code>、<code>reader.txt</code>，把<code>MacVim</code>放到你的应用程序也就是<code>/Applications</code>目录下，把<code>mvim</code>拷贝到<code>/usr/bin/</code>目录下。这样<code>MacVim</code>就可以正常使用了：终端下使用<code>mvim</code>或直接打开MacVim应用。</p>

<h3>安装插件(plugin)</h3>

<p>vim 有好多方便、实用的插件，作为一个普通开发人员，经常使用的就有一二十个，若一个一个去安装确实有点麻烦。</p>

<p><a href="https://github.com/carlhuda/janus"><code>Janus</code></a>可以为我们解决这个烦恼，它是一个为<code>Vim</code>、<code>Gvim</code>、<code>MacVim</code>准备的插件和映射的集合。Janus用一些最流行的插件和最常用的映射组合成一个最小型的开发环境。参见 <a href="https://github.com/carlhuda/janus">Janus的Github页面</a>。</p>

<p>1、安装</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -Lo- https://bit.ly/janus-bootstrap | bash</span></code></pre></td></tr></table></div></figure>


<p>2、自定义</p>

<p>可以在<code>~/.vimrc.before</code>中做一些 <em>leader</em> 设置，其他设置可以放在 <code>~/.vimrc.after</code>里。</p>

<p>如果想安装其他的插件，就要创建一个<code>~/.janus</code>目录存放插件。也可以使用<code>git clone</code>，例如：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/.janus
</span><span class='line'>$ git clone https://github.com/nathanaelkane/vim-indent-guides.git</span></code></pre></td></tr></table></div></figure>


<p>这是一个缩进对齐插件（效果参见配图中明暗相间的竖条），需要在下面所说的<code>~/.vimrc.before</code>文件中添加：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>autocm vimenter * :IndentGuidesEnable
</span><span class='line'>let g:indent_guides_guide_size = 1</span></code></pre></td></tr></table></div></figure>


<h3>安装主题(theme)</h3>

<p>我是做<code>Rails</code>开发的，之前一直用的<code>Textmate</code>编辑器，比较喜欢之前的配色方案。有两款合适的配色方案：<a href="https://github.com/ryanb/dotfiles/blob/master/vim/colors/railscasts.vim">Railscasts.vim</a> 和 <a href="https://github.com/gigamo/sunburst.vim/blob/master/.vim/colors/sunburst.vim">Sunburst.vim</a> 。</p>

<p>在<code>~/.vim</code>目录下新建<code>colors/</code>目录，将<code>Railscast.vim</code>或<code>Sunburst.vim</code>放到此目录中，然后在<code>~/.vimrc.before</code>文件中添加启用此主题的设置项：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>colorscheme Sunburst </span></code></pre></td></tr></table></div></figure>


<p>其他配色方案请参考 <a href="http://www.oschina.net/news/32306/10-vim-color-schemes-you-need-to-own">10 个你值得拥有的 Vim 配色方案</a> ，设置与上面一样。</p>

<h3>其他设置</h3>

<p>一般情况下Janus安装插件的时候已经做了许多默认的设置，下面是根据我自己的需求做的设置<code>~/.vimrc.before</code>：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>" 设置主题（配色方案）
</span><span class='line'>colorscheme Sunburst
</span><span class='line'>" 设置字体字号
</span><span class='line'>set guifont=Menlo:h16
</span><span class='line'>" 启用缩进高亮对齐（下图中明暗相间的竖条） 
</span><span class='line'>autocm vimenter * :IndentGuidesEnable
</span><span class='line'>" 设置缩进距离单位
</span><span class='line'>let g:indent_guides_guide_size = 1
</span><span class='line'>" 设置mapleader键位
</span><span class='line'>let mapleader = ","
</span><span class='line'>" 设置文件打开时代码段默认为折叠状态
</span><span class='line'>set foldmethod=indent</span></code></pre></td></tr></table></div></figure>


<h3>示例配图</h3>

<p><img src="http://windstill.me/images/post_img/A84412D6-BA8F-49F3-B48A-1A4AB8F67E48.png" title="示例配图" alt="example" /></p>

<h3>参考文章</h3>

<ul>
<li><a href="http://kodira.de/2013/10/macvim-osx-10-9-mavericks/">MacVim for OSX 10.9 Mavericks</a></li>
<li><a href="http://blog.csdn.net/wildcatlele/article/details/16330009">mac osx 10.9安装配置macvim</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[用Octopress和Github-pages搭建博客]]></title>
    <link href="http://windstill.me/blog/2013/12/26/octopress-with-github-pages/"/>
    <updated>2013-12-26T21:07:44+08:00</updated>
    <id>http://windstill.me/blog/2013/12/26/octopress-with-github-pages</id>
    <content type="html"><![CDATA[<h3>1 相关介绍</h3>

<h4>Octopress</h4>

<p><a href="http://octopress.org/"><code>Octopress</code></a>是利用<a href="http://github.com/mojombo/jekyll"><code>Jekyll</code></a>博客引擎开发的一个博客系统，生成的静态页面能够很好的在github page上展现。如果用<a href="http://github.com/mojombo/jekyll"><code>Jekyll</code></a>写博客的话，得要自己写HTML模板、CSS、Javascript，并且要自己做配置。但是如果用<a href="http://octopress.org/"><code>Octopress</code></a>，这些都帮你做好了，只要<a href="https://github.com/imathis/octopress"><code>clone or fork Octopress</code></a>，安装些依赖的库和主题就行了。</p>

<!-- more -->


<h4>Github pages</h4>

<p><a href="https://github.com/"><code>GitHub</code></a>是全球最大的社交编程及代码托管网站，GitHub可以托管、分享各种代码库或项目，并提供一个web界面。</p>

<p><a href="http://pages.github.com/"><code>Github Pages</code></a>就是为你或你的项目提供一个静态的网站。原理就是把你的一个特殊的repository (yourname.github.io)，或者某个repository特殊分支(gh-pages)的静态文件以网页形式展现出来，前者一般作为个人主页，后面一般作为项目的主页，这两种情况后面会说到。</p>

<p>这种方案优势：1.搭建、发布简单；2.免费、无限流量，3.绑定自己域名</p>

<h3>2 安装Octopress</h3>

<h4>安装前准备</h4>

<ul>
<li><a href="http://git-scm.com/">安装 Git</a></li>
<li>安装 Ruby 1.9.3</li>
</ul>


<p>可以通过安装RVM，来安装、管理ruby版本</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -L https://get.rvm.io | bash -s stable --ruby</span></code></pre></td></tr></table></div></figure>


<p>接着是安装Ruby 1.9.3</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rvm install 1.9.3
</span><span class='line'>rvm use 1.9.3</span></code></pre></td></tr></table></div></figure>


<h4>安装Octopress</h4>

<p>克隆Octopress的代码库</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://github.com/imathis/octopress.git octopress
</span><span class='line'>cd octopress</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>安装依赖库</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install bundler
</span><span class='line'>rbenv rehash    # If you use rbenv, rehash to be able to run the bundle command
</span><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>


<p>安装Octopress默认主题</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake install</span></code></pre></td></tr></table></div></figure>


<h3>3 配置Octopress</h3>

<p>Octopress的作者已经让配置尽量简化了，一般情况只需要配置<code>_config.yml</code>和<code>Rakefile</code>文件即可。下面是Octopress的配置文件列表。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_config.yml       # 主要配置文件 (Jekyll的设置)
</span><span class='line'>Rakefile          # 部署相关配置
</span><span class='line'>config.rb         # Compass config
</span><span class='line'>config.ru         # Rack config</span></code></pre></td></tr></table></div></figure>


<p><code>_config.yml</code>文件中主要有三大配置段：<code>Main Configs</code>、<code>Jekyll &amp; Plugins</code>和<code>3rd Party Settings</code>。一般，该文件中其中url是必须要填写的，这里的url是在github上创建的一个仓库地址，具体请看第四步中创建的地址。另外再修改一下title、subtitle和author，根据需求，再开启一些第三方组件服务。</p>

<p>参见 <a href="http://octopress.org/docs/configuring/">Configuring Octopress</a></p>

<h3>4 部署到Github Pages</h3>

<h4>Github User/Organization pages</h4>

<p>如果想放到<code>http://username.github.io</code>域名下，就用这种方式。以前是<code>.com</code>域名，现在改成<code>.io</code>了。不过可以配置自己的域名，这个后面会说到。</p>

<p>首先需要在GitHub上创建一个<a href="https://github.com/repositories/new">新的仓库</a>，命名为<code>username.github.io</code>，<code>username</code>就是你在Github的用户名。等后面配置好部署到Github上以后，就可以通过<code>http://username.github.io</code>访问了。这种方式需要一个master分支来存放生成的博客内容（_deploy目录），source分支存放整个源码。用octopress的一个<code>rake任务</code>可以自动完成以上配置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake setup_github_pages</span></code></pre></td></tr></table></div></figure>


<p>这条rake任务会让你输入仓库的地址，SSH和HTTPS的URL都可以。执行后，会做以下事情：<br/>
1. 存储Github Pages的仓库地址<br/>
2. 将octopress的远程仓库<code>origin</code>重命名为<code>octopress</code><br/>
3. 将Github Pages仓库作为默认的远程origin<br/>
4. 将当前分支从<code>master</code>切换到<code>source</code><br/>
5. 根据仓库地址配置博客的URL<br/>
6. 在部署目录<code>_deploy</code>中创建<code>master</code>分支</p>

<p>然后执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake generate
</span><span class='line'>rake deploy</span></code></pre></td></tr></table></div></figure>


<p>这两条命令会生成博客系统的主要文件并拷贝到<code>_deploy/</code>目录，然后添加到git版本控制，提交并推送到远程主分支。过一会就可以访问<code>http://username.github.com</code>了。</p>

<p>然后把源码提交到<code>source</code>分支</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git add .
</span><span class='line'>git commit -m 'your message'
</span><span class='line'>git push origin source</span></code></pre></td></tr></table></div></figure>


<h4>Github Project pages (gh-pages分支)</h4>

<p>Github的Project Pages服务可以为项目提供网站页面。它会在项目仓库中寻找<code>gh-pages</code>分支，然后通过<code>http://username.github.io/project</code>访问项目网站。</p>

<p>执行Octopress的rake任务命令</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake setup_github_pages</span></code></pre></td></tr></table></div></figure>


<p>然后执行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake generate
</span><span class='line'>rake deploy</span></code></pre></td></tr></table></div></figure>


<p>这几条命令的执行结果基本与上面的类似。</p>

<p>参见 <a href="http://octopress.org/docs/deploying/github/">Deploying to Github Pages</a></p>

<h4>自定义域名</h4>

<p>首先在<code>source/</code>目录下新建一个名为<code>CNAME</code>的文件，并填入你的域名，比如<code>example.com</code>或<code>blog.example.com</code>。</p>

<p>然后到你的域名登记或DNS管理网站添加一条域名记录</p>

<ul>
<li>如果是顶级域名，比如<code>example.com</code>，那么需要创建一条A记录，并指向<code>204.232.175.78</code>。</li>
<li>如果是二级域名，比如<code>blog.example.com</code>，那么创建一条CNAME记录，并指向<code>username.github.io</code>。</li>
</ul>


<p>然后执行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake generate
</span><span class='line'>rake deploy</span></code></pre></td></tr></table></div></figure>


<p>大概过个10分钟，就可以用新的域名访问了。</p>

<h3>5 开始写博客</h3>

<p>Octopress提供了一些rake任务来创建博文和页面。博文必须存储在source/_posts目录下，其中预置了一些元数据，并且以Jekyll的命名规范命名：YYYY-MM-DD-post-title.markdown。博文的名字会被当做url的一部分，而其中的日期用于对博文的区分和排序。</p>

<h4>创建博文</h4>

<p>通过Octopress提供的rake任务可以正确的按照命名规范创建博文，并且在博文中会预知一些常用的yaml元数据。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake new_post["title"]</span></code></pre></td></tr></table></div></figure>


<p>其中title为博文的文件名，创建出来的文件默认是markdown格式。上面的命令会创建出这样一个文件：source/_posts/2013-08-03-title.markdown。用文本编辑器打开这个文件，可以看到里面有一块yaml元数据(Jekyll博客引擎会根据这些内容处理博文和页面)：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>layout: post
</span><span class='line'>title: "Zombie Ninjas Attack: A survivor's retrospective"
</span><span class='line'>date: 2011-07-03 5:59
</span><span class='line'>comments: true
</span><span class='line'>external-url:
</span><span class='line'>categories:
</span><span class='line'>---</span></code></pre></td></tr></table></div></figure>


<h4>设置博文</h4>

<p>在以上的yaml元数据块里可以：</p>

<ul>
<li>关闭评论</li>
<li>给博文添加分类</li>
<li>如果是多人博客，可以添加<code>author: Your Name</code>到元数据</li>
<li>如果只是想作为草稿，不想在发布后公开，那么可以添加<code>published: false</code></li>
<li>如果是想发布个外链博文，只要为博文添加个<code>external-url</code></li>
</ul>


<p>你还可以想下面这样添加一个或多个分类：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 一个分类
</span><span class='line'>categories: Sass
</span><span class='line'> 
</span><span class='line'># 多个分类，示例1
</span><span class='line'>categories: [CSS3, Sass, Media Queries]
</span><span class='line'> 
</span><span class='line'># 多个分类，示例2
</span><span class='line'>categories:
</span><span class='line'>- CSS3
</span><span class='line'>- Sass
</span><span class='line'>- Media Queries</span></code></pre></td></tr></table></div></figure>


<h4>撰写博文</h4>

<p>在元数据块下面就可以撰写博文正文了。</p>

<p>如果想在首页中只显示博文的部分正文，可以在博文中写入<code>&lt;!--more--&gt;</code>，这样首页的博文就只显示<code>&lt;!--more--&gt;</code>标识之前的内容，并在每篇博文底下加一个<code>Read on</code>超链接。</p>

<h4>生成并预览</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake generate   # 生成post和page到public目录
</span><span class='line'>rake preview    # 启动服务并预览 http://localhost:4000</span></code></pre></td></tr></table></div></figure>


<p>预览无勿的话，就可以部署了</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake deploy</span></code></pre></td></tr></table></div></figure>


<p>参见 <a href="http://octopress.org/docs/blogging">Start blogging with Octopress</a></p>

<h3>参考文章</h3>

<ul>
<li><a href="http://blog.devtang.com/blog/2012/02/10/setup-blog-based-on-github/">利用Octopress搭建一个Github博客</a></li>
<li><a href="http://blog.devtang.com/blog/2012/02/10/setup-blog-based-on-github/">象写程序一样写博客：搭建基于github的博客</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
